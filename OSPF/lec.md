# Протоколы Link-State [OPSF](https://habr.com/ru/articles/418391/)

## Алгоритм работы Link-State протокола

1. Каждый роутер получает сведения о каждой из своих непосредственно подключенных сетей

2. Каждый роутер отвечает за отправку hello-сообщений соседним устройствами в рамках напрямую подключенных сетей

3. Каждый роутер создаёт пакет состояния канала (LSP), в котором содержаться данные о состоянии каждого из напрямую подключенных каналов

4. Каждый роутер выполняет лавинную рассылку пакетов состояния канала всем соседним устройстам, которые затем сохраняют полученные пакеты в бд

5. Каждый роутер использует бд для создания общей схемы топологии и расчёта оптимального пути в каждую сеть назначения

1. исследование подключенных сетей
![alt text](image.png) 

что изучает роутер о своих подключенных сетях
![alt text](image-1.png)

2. Рассылка hello сообщений
![alt text](image-2.png)

![alt text](image-3.png)

3. Рассылка LSP сообщений, в которых содержится информация о канале, в те каналы, в которых были обнаружены соседи

LSP содержит тип сети, адрес сети, стоимость канала
![alt text](image-4.png)

![alt text](image-5.png)

4. После получения LSP сообщения роутеры, продублируют(**лавинная рассылка**) это сообщение на все подключенные интерфейсы(кроме интерфейса, из которого пакет был получен)

полученный LSP пакет помещается в бд роутера

Пакеты рассылаются только при изменении топологии:
* если роутер первый раз включился в процесс работы маршрутизации
* подключён или вышел из строя канал связи
**В пакетах будет инфа только об изменениях в сети**

![alt text](image-6.png)

![alt text](image-7.png)

5. Постройка топологии сети на основе данных из бд
![alt text](image-8.png)

Как выглядит бд на R1 при полном исследовании топологии. Такая бд должна быть заполнена на всех роутерах, участвующих в маршрутизации
![alt text](image-9.png)

## Построение Дерева SPF
Топология на всех роутерах одинаковая, за счёт одинаковой заполненности бд

Роутер R1 проходится по бд и добавляет в таблицу топологии новые сети.

Если какая-то строчка встречается дважды, то роутер её пропускает
![alt text](image-10.png)

Построив топологию сети, роутер использует алгоритм дейкстры для нахождения оптимального маршрута до каждой сети

## Кратчайший путь

![alt text](image-11.png)

Найдя кратчайшие пути, роутер заполняет таблицу маршрутизации.
**таблица маршуртизации у всех роутеров своя, а вот бд общая**
![alt text](image-12.png)

Автоматически попадают directly connected и маршруты полученные другими способами

## Преимущества и недостатки

![alt text](image-13.png)

## Иерархия Link-State

![alt text](image-14.png)

Общий домен маршрутизации можно поделить на области, внутри которых будет происходить полный процесс работы протокола 

между областями передаётся сокращенная информация, позволяющая не хранить всю бд других областей

изменения в одной области не тригерит перерасчёт маршрутов в других областях

**иерархичность нужно уметь спланировать и настроить**

![alt text](image-15.png)

# Принцип работы OSPF

## Развитие протокола OSPF
![alt text](image-16.png)

![alt text](image-17.png)

* на текущий момент действуют только 2(ipv4) и 3(ipv6) версии OSPF
* Принцип работы 2 и 3 версии одинаков

## Компоненты OSPF

![alt text](image-18.png)

![alt text](image-19.png)

База данных состояния канала содержит все LSP сообщения и на её основе создаётся таблица топологии. Эта бд должна совпадать у всех роутеров, отсюда следует одинаковость таблицы топологии

База данных перессылки строится на основе бд состояния канала с помощью алгоритма дейкстры

## Принцип работы
![alt text](image-21.png)
![alt text](image-20.png)

![alt text](image-22.png)
Лавинная рассылка LSA сообщений
![alt text](image-23.png)

![alt text](image-24.png)
![alt text](image-25.png)

![alt text](image-27.png)
![alt text](image-26.png)

![alt text](image-28.png)
![alt text](image-29.png)

**У всех роутеров в одном домене маршрутизации должны совпадать бд состояния канала**

**Таблица маршрутизации у каждого роутера уже своя. Она вычисляется на основе таблицы топологии**

## Single-Area и Multiarea OSPF

обычная настройка протокола
![alt text](image-30.png)

введение иерархии, позволяющая разделить домен маршрутизации на обласи. Внутри каждой области маршуртизация работает как в singlearea

Области взаимодействуют между собой
![alt text](image-31.png)

## Преимущества Multiarea OSPF

![alt text](image-32.png)

* Выгодно использовать в сетях большого размера
  * Позволяет меньше загружать сеть пересылкой служебных сообщений с помощью деления сети на области
  * любое изменение в сети влияют на перерасчёт пути только в этой области

## Типы пакетов OSPF
![alt text](image-33.png)
1. hello пакеты - поиск соседей поддержка смежности
2. DBD (database description packet) - сокращенный список LSDB состояний каналов отправляющего маршрутизатора. **LSDB должна быть идентичной в области**
   1. Перечисление каналов и роутеров, известных текущему роутеру
3. Link-State Request (LSR) packet - запрос определенной инфы из бд
4. Link-State Update (LSU) packet - ответ на LSR, а также распространение новой инфы. 7 типов LSA
5. Link-State Acknoledgment(LSAck) packet - подтверждение на LSU
   1. Каждый ответ должен быть подтвержден

## Типы LSA (виды сообщений LSU)

![alt text](image-34.png)


## Инкапсуляция OSPF сообщений

![alt text](image-35.png)

## формат hello пакета

![alt text](image-36.png)

![alt text](image-37.png)

**у всех роутеров должны совпадать hello интервалы**

## Состояния OSPF

DR - designated router
BDR - backup designated router

**если сеть точка точка, то после Init State переходим в ExStart State**

![alt text](image-38.png)

![alt text](image-39.png)

## Установление соседства

Router id устанавливается также как в EIGRP
![alt text](image-40.png)


## Синхронизация бд
![alt text](image-41.png)

## OSPF DR and BDR
DR и BDR выбираются в сетях с множественным доступом, т.е в сетях ethernet

подключенные друг к другу роутеры должны устанавливать отношение смежности и в сетях с разделенным доступом может оказаться большое кол-во смежностей у каждого роутера

Много смежностей -> Частый обмен большим кол-вом сообщений LSA -> роутеры получают один и тот же пакет LSA по нескольку раз и растёт нагрузка на сеть

Поэтому выбирают основной выделенный роутер, который устанавливает отношение смежности с другими роутерами(DRBrother), а также резервный выделенный роутер. Это обеспечивает пересылку меньшего числа сообщений


![alt text](image-42.png)

## Настройка OSPF

![alt text](image-43.png)

### Включить процесс ospf
![alt text](image-44.png)
**process-id - не должен совпадать на всех роутерах**
Рекомендуется использовать одинаковый proccess-id в одном домене маршрутизации
это 2 байтовое поле
![alt text](image-49.png)
### Настройка router ID
Процесс выбора Router ID такой же как в eigrp
![alt text](image-45.png)
![alt text](image-50.png)
### Включить OSPF маршрутизацию на интерфейсе
![alt text](image-46.png)
для single ospf используй area_id = 0
![alt text](image-51.png)
### Включить OSPF маршрутизацию на интерфейсе(альтернативный вариант)
![alt text](image-47.png)
![alt text](image-52.png)
### Перезапустить процесс OSFP
понадобится когда хотим заменить router id, т.к роутер уже успел установить смежность с другими роутерами.

Вместо перезапуска процесса ospf можно перезапустить роутер
![alt text](image-48.png)
### настройка opsf через интерфейс
![alt text](image-53.png)

### Настройка passive интерфейсов
![alt text](image-54.png)
### Настройка глобального passive interface
![alt text](image-55.png)

## Расчёт метрики в OSPF
 
$$
\text{стоимость =} \frac{\text{эталонное значение пропускной способности}}{\text{пропускная способность канала}}
$$

по умолчанию эталонное значение это $10^{8}$

в качестве стоимости выбирается ближайшее целое
![alt text](image-56.png)

### регулировака эталонного значения пропускной способности
![alt text](image-58.png)
### Установить эталонное значение по умолчанию
![alt text](image-57.png)

Пример на котором заменили эталонное значение и как это повлияло на расчёт метрики
![alt text](image-59.png)

### Проверка, что стоимость правильно установилась
![alt text](image-60.png)

### Настройка пропускной способности канала
![alt text](image-61.png)

### Настройка стоимоти
стоиость влияет только на ospf и не затрагивает другие протоколы
![alt text](image-62.png)

![alt text](image-63.png)

## Команды проверки OSPF

### Проверка соседей
![alt text](image-64.png)
![alt text](image-68.png)
1 столбик - router id соседа
2 столбик - приоритет интерфейса
3 столбик - состояние интерфейса. **Full - смежность установлена**
4 столбик - deadtime (время которое осталось до того момента, как мы начнем считать соседний роутер вышедшим из строя)
5 столбик - интерфейс через который мы подключены к соседнему роутеру
### Проверка настройки протокола
![alt text](image-65.png)
![alt text](image-69.png)
**соседство не установится если отличаются hello и deadtime таймеры**
### Проверка данных процесса OSPF
показывает логи процесса ospf
![alt text](image-66.png)
![alt text](image-70.png)
### Проверка настройки интерфейсов
показывает какие интерфейсы участвуют в работе ospf
![alt text](image-67.png)
![alt text](image-71.png)

## OPSFv3
**алгоритм работы, структуры данных, сообщения такие же как у ospfv2**

отличие только в протоколе сетевого уровня и адресация. В ospfv3 - ipv6, а ospfv2 - ipv4

**версии ospf не совместимы**

## Сходства ospfv3 и ospfv2

![alt text](image-72.png)

менять эталонную стоимость нужно отдельно менять на ospfv3 и ospfv2
указание router_ir при работе в ipv6 сетях обязательно

## Различия ospfv3 и ospfv2
![alt text](image-73.png)

## Пример настройки ospf для ipv6

![alt text](image-74.png)
![alt text](image-75.png)
![alt text](image-76.png)
![alt text](image-77.png)
![alt text](image-78.png)
![alt text](image-79.png)
![alt text](image-80.png)
