# Multi area ospf

## Проблемы Single area ospf в больших сетях

![alt text](image.png)
![alt text](image-1.png)

Multi area ospf позволяет избежать проблемы ospf при больших сетях

## Multi area ospf

**Мы делим сеть на области за счёт чего и происходит выигрыш**

![alt text](image-2.png)

![alt text](image-3.png)

**Требуется иерархическая структура сети (адресация сети должна предусматривать разделение на области)**

## Backbone and Regular Areas

![alt text](image-4.png)
В OSPF всего 2 уровня:
1. Backbone(обязательно должна присутствовать). Является транзитной областью для не магистральных областей.
   1. Должна быть только **ОДНА** магистральная область
   2. Магистральная область обозначается Area 0
   3. **Только передаёт трафик между немагистральными областями**
   4. Здесь не настраиваются пользовательские сети
2. Regular
   1. Все Regular области должны быть связаны с Backbone областью
   2. Происходит подключение пользаков к сети
   3. Настройка пользовательских сетей
![alt text](image-5.png)

Рекомендации для лучшей производительности
![alt text](image-6.png)

**В зависимости от того, в какой области подключён роутер у них есть несколько ролей**

## Internal router

![alt text](image-7.png)
![alt text](image-8.png)

## Backbone router

![alt text](image-9.png)

![alt text](image-10.png)

## Area border Router (ABR)

![alt text](image-11.png)

![alt text](image-12.png)

## Autonomous System Boundary Router (ASBR)

**Интерфейс подключен к сети, работающей за пределами текущего процесса ospf**

Например: 
1. Интернет
2. Сеть с другим протоколом маршрутизации
3. Сеть с другим процессом ospf

![alt text](image-13.png)
![alt text](image-14.png)

## Типы LSA

![alt text](image-15.png)

![alt text](image-16.png)

## Type 1 LSA

![alt text](image-17.png)
![alt text](image-18.png)

## Type 2 LSA

![alt text](image-19.png)
![alt text](image-20.png)

## Type 3 LSA

Вот здесь аккуратнее, **Требуется настройка объединения маршрутов на границе области**, иначе никакого multy area ospf не будет, т.к будет LSA 3 будет по фактц совпадать с LSA 1 и кол-во переданных пакетов не уменьшится

**По умолчанию маршруты не объединяются**

![alt text](image-21.png)
![alt text](image-22.png)

## Type 4 LSA

ASBR Отправляет LSA 1ого типа, но добавляется метка E - external, т.е маршрут был получен за пределами домена маршрутизации OSPF

Получив такой пакет ABR генерирует TYPE 4 LSA

![alt text](image-23.png)
![alt text](image-24.png)

## Type 5 LSA

Требуется настройка объединения внешних сетей, иначе на каждую сеть будет сгенерирован и разослан type 5 LSA, что негативно влияет на нагрузку сети 

![alt text](image-25.png)

![alt text](image-26.png)


## Таблица маршрутизации IPv4

![alt text](image-27.png)
****
**Маршруты помеченные буквой O** - маршруты изученные в пределах одной области(LSA 1/ LSA 2)

**Маршруты помеченные IA** - Маршруты(из других областей) изученные с помощью LSA 3 типа, т.е были переданы граничным маршрутизатором

**Маршруты помеченные E2** - Внешние маршруты (сети ведущие за пределы данного домена маршрутизации OSPF) переданные с помощью LSA 5 типа 
   * E2 используется по умолчанию
   * E1 и E2 обозначают способ которым вычисляется метрика в сети
     * E1 - подсчёт метрики во внешнем домене
     * E2 - подсчёт метрики внутри домена маршрутизации, т.е начиная с ASBR

## Таблица маршрутизации IPv6

![alt text](image-28.png)

Метки и их логика такие же

## Порядок вычисления маршрута

![alt text](image-29.png)

1. Изучение сетей внутри области, строит свою бд состояния каналов, которая должна совпадать для всех роутеров внутри одной области. Вычисляется кротчайшей маршрут и он добавляется в таблицу маршрутизации

2. В таблицу маршрутизации добавляются маршруты, полученные от граничных роутеров. Эти сети добавляются без процесса вычисления кротчайшего сети

3. В таблицу маршрутизации добавляются внешние сети 

# Настройка Multi area OSPF

Чтобы маршрутизатор считался граничным, нужно настроить area таким образом, чтобы разные интерфейсы одного маршрутизатора принадлежали разным area

## Для IPv4
**Вместо 0 указывай другой номер для area**

R2 настраивается так же, как OSPF single area

![alt text](image-30.png)

![alt text](image-31.png)

## Для IPv6

![alt text](image-32.png)
![alt text](image-33.png)


## show ip protocols

![alt text](image-34.png)

## show ip ospf interface brief

![alt text](image-35.png)

## show ip route

![alt text](image-36.png)

## show ip ospf database

показать link-state database

Базы данных для разных областей делятся на сегменты
![alt text](image-37.png)

## show ipv6 protocols

![alt text](image-38.png)

## show ipv6 ospf interface brief
![alt text](image-40.png)

## show ipv6 route
![alt text](image-39.png)

# Сети с множественным доступом

## Типы OSPF сетей

**В курсе рассматриваем только point-to-point и broadcast multiaccess**

### Point-to-Point - только 2 устройства
![alt text](image-41.png)

### Broadcast multiaccess - несколько устройств через ethernet
![alt text](image-42.png)

### Nonbroadcast multiaccess (NBMA) - несколько устройств в сети без широковещания(Frame Relay)

![alt text](image-43.png)

### Point-to-multipoint - есть общая точка соединения
![alt text](image-44.png)

### Virtual links - сеть для соединения удаленных area к area 0
![alt text](image-45.png)
Заметь, что область area 1 не транзитная, т.е происходит соединение 2х областей через нетранзитную область

## Настройка канала типа point-to-point

в каналах с множественным доступом(Ethernet) выбираются выделенный роутер(DR) и резервный выделенный роутер(BDR)

![alt text](image-46.png)

В сетях, в которых на ethernet канале всего 2 подключенных устройства(point-to-point по факту), т.е выбор DR и BDR не имеет смысла. Поэтому хочется перенастроить тип канала, чтобы роутер не искал DR и BDR 

![alt text](image-47.png)

**Чтобы избежать этого вводим команду**

![alt text](image-48.png)

* В ручную установили тип канала point-to-point

Проверка после выполнения команды

![alt text](image-49.png)

**Команда уменьшает время сходимости OSPF**

## Проблемы в широковещательных сетях

Значение выделенного роутера и как можно повлиять на его выборы

![alt text](image-50.png)

![alt text](image-51.png)

![alt text](image-52.png)

Если сеть подразумевает множественный доступ для нескольких роутеров, то по принципу работы OSPF, каждый роутер должен выстроить отношения смежности с каждым роутером(может быть очень большим кол-вом, при малом кол-ве роутеров)

OSPF делает лавинную рассылку сообщений(+ подтверждения) для каждой смежности, что может значительно снизить производительность канала связи

Чтобы ограничить поток служебных сообщений выбирается DR и BDR. С ними устанавливают отношение смежности все роутеры(DR other). Затем при при изменениях в сети. Dr делает лавинную рассылку на Dr other на адрес 224.0.0.5

![alt text](image-53.png)
![alt text](image-54.png)

## Роли DR\BDR

![alt text](image-55.png)
![alt text](image-56.png)

Просмотр роли роутера
![alt text](image-57.png)
![alt text](image-58.png)
![alt text](image-59.png)

### DR\BDR смежность
![alt text](image-60.png)

В таблице соседей для канала с множественным доступом, канал должен быть в статусе `full`, иначе делаем вывод что при настройке ospf произошёл сбой. Но есть исключение, может быть состояние towait - этап сходимости ospf, либо когда drother подключен к другому **dr other, т.к dr other не устанавливают отношение смежности друг с другом**

### Процесс выбора DR/BDR

приоритет = 0 - маршрутизатор никогда не участвует в выборах dr

![alt text](image-61.png)

![alt text](image-62.png)

Выборы DR и BDR происходят сразу же, как только интерфейс был добавлен в процесс ospf -> Первым может загрузиться идентификатор с наименьшим id, он и станет dr

## Сбой и восстановление DR
![alt text](image-63.png)
![alt text](image-64.png)
При поломке DR BDR сразу же принимает его роль и становится DR, BDR становится следующий по приоритету роутер

Если DR сломался, т.е появился новый DR, то он не станет DR вновь, т.к перевыборы не происходят. Таким образом он становится DRother


Можно установить приоритет интерфейса, чтобы повлиять на выбор BDR и DR роутеров. 
* Значение от 0 до 255.
* 0 - роутер не участвует в выборах
* 255 - гарантирует, что роутер станет DR в процессе выборов
* Можно менять выбор DR и BDR в разных area, таким образом снижая нагрузку на роутер
## настройка приоритета в ipv4
![alt text](image-65.png)
![alt text](image-67.png)

## настройка приоритета в ipv6
![alt text](image-66.png)

## Проверка что приоритет изменился

![alt text](image-68.png)

## Распространение Маршрута по умолчанию

![alt text](image-69.png)

![alt text](image-70.png)

![alt text](image-71.png)

![alt text](image-72.png)

![alt text](image-73.png)

![alt text](image-74.png)

## Регулирование Hello и Dead Intervals

![alt text](image-75.png)

![alt text](image-76.png)

![alt text](image-77.png)

![alt text](image-78.png)